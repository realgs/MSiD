{% import 'macros.html' as m %}

{% extends "main.html" %}
{% block content %}
<form class="wallet" action="">
  {{ m.progress_bar('wallet_refresh_bar') }}
  {% for (currency, value) in wallet %}
  <div class="group">
    <div>{{currency}}</div>
    <input type="text" name="{{currency}}" value="{{value}}">
  </div>
  {% endfor %}
  <button class="btn update">Aktualizuj</button>
</form>
{% endblock %}

{% block scripts %}
<script>
  const update_wallet_btn = document.querySelector('.btn.update');
  const update_wallet_form = document.querySelector('.wallet');
  const update_wallet_url = '/update_wallet';
  const get_wallet_url = '/get_wallet';
  const wallet_refresh_delay = 5000;
  const wallet_refresh_bar = document.querySelector('.wallet_refresh_bar');

  function refresh_wallet() {
    fetch(get_wallet_url)
      .then(response => response.json())
      .then(wallet => {
        wallet.forEach(item => {
          const currency = item[0];
          const value = item[1];
          const currency_input = document.querySelector(`input[name=${currency}]`);
          currency_input.value = value;
        });
      });
  }

  let bar_step = 0;
  function update_bar() {
    if(bar_step < 100) bar_step++;
    else {
      bar_step = 0;
      refresh_wallet()
    }
    wallet_refresh_bar.style.width = `${bar_step}%`;
  }

  function update_wallet() {
    event.preventDefault();
    const data = new URLSearchParams(new FormData(update_wallet_form))

    fetch(update_wallet_url, {
      method: 'post',
      body: data,
    });
  }

  refresh_wallet()
  setInterval(update_bar, wallet_refresh_delay/100)
  update_wallet_btn.onclick = update_wallet;
</script>
{% endblock %}
