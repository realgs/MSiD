<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content = "width=device-width, initial-scale=1.0">
        <title>Crypto Wallet</title>

        <link rel="shortcut icon" type="image/png" href="images/favicon.png"/>
        <link rel="stylesheet" href="css/main.css">
    </head>
    <body>
        <header class="main_header">
            <h1>Crypto Wallet</h1>
            <img src="images/favicon.png" alt="">
        </header>

    <main>
        <section class="content">
            <p>pick sth</p>
            <select id="forex_select" name="forex">
                 <option value="USD">USD</option>
                 <option value="EUR">EUR</option>
                 <option value="PLN">PLN</option>
                 <option value="GBP">GBP</option>
            </select>

            <h4>paste in your wallet data or upload a file {JSON}</h4>
            <textarea name="wallet_input" rows="8" cols="50" id="wallet_input"></textarea>
            <input type="file" name="wallet_input_file" class="hidden" id="wallet_input_file">

            <button type="button" name="button" id="submit_data">apply</button>
            <!-- <button type="button" name="button" id="download_wallet">download output wallet</button> -->

            <ul id="wallet_summary_node"></ul>
        </section>

        <section class="side-right">
            <header>
                <h3>Real-time stocks</h3>
                <nav>
                    <h4 class="selected" id="select_orders">orders</h4>
                    <h4 id="select_trades">trades</h4>
                </nav>
            </header>
            <section id="real_time_container"></section>
        </section>
    </main>

    <script src="js/bitfinex.js"></script>
    <script src="js/bitbay.js"></script>

    <script type="text/javascript">

        const REFRESH_INTERVAL = 8000;

        var select_orders = document.getElementById('select_orders');
        var select_trades = document.getElementById('select_trades');
        var forex_select = document.getElementById('forex_select');

        var wallet_input = document.getElementById('wallet_input');
        var wallet_input_file = document.getElementById('wallet_input_file');

        var submit_data = document.getElementById('submit_data');
        var download_wallet = document.getElementById('download_wallet');

        var rates_container = document.getElementById('real_time_container');
        var wallet_summary_node = document.getElementById('wallet_summary_node');

        var orders_data_list = document.createElement('UL');
        var trades_data_list = document.createElement('UL');

        currencies = ["LTC", "BTC", "ETH"];
        sockets = [new bitfinex_socket("LTC"), new bitbay_socket("LTC")]
        // bitfinex = new bitfinex_socket("LTC");
        // bitbay = new bitbay_socket("LTC");
        // ftx = new ftx_socket("LTC");

        currencies.forEach((currency) => { sockets.forEach((socket) => { socket.subscribe(currency); }); });

        var bids = {};
        var asks = {};
        var trades = {};
        var forex = {};
        wallet = {};
        wallet_summary = {};

        function toggle_orders_trades(selection)
        {
            if(selection === "orders")
            {
                select_orders.classList.add("selected");
                select_trades.classList.remove("selected");
                rates_container.removeChild(trades_data_list);
                rates_container.appendChild(orders_data_list);
            }
            else
            {
                select_trades.classList.add("selected");
                select_orders.classList.remove("selected");
                rates_container.removeChild(orders_data_list);
                rates_container.appendChild(trades_data_list);
            }
            refresh();
        }

        select_orders.addEventListener("click", function() { toggle_orders_trades("orders"); });
        select_trades.addEventListener("click", function() { toggle_orders_trades("trades"); });
        forex_select.addEventListener("change", refresh);

        wallet_input_file.addEventListener("change", async function(event)
        { wallet_input.innerHTML = await event.target.files[0].text(); });

        submit_data.addEventListener("click", function()
        { refresh_wallet(JSON.parse(wallet_input.value)); });

        function refresh_wallet(wallet_value)
        {
            wallet = wallet_value;
            wallet_summary = {};
            wallet_summary["sum"] = 0;
            wallet_summary_node.innerHTML = "";

            if(select_orders.classList.contains("selected"))
            {
                for (var currency in wallet)
                {
                    amount = wallet[currency];
                    wallet_summary[currency] = 0;
                    if(currencies.includes(currency))
                    {
                        forex_rate = forex[forex_select.value];

                        sockets.sort(function(a, b)
                        {
                            if(a.data.ticker[currency].bid_price > b.data.ticker[currency].bid_price) return 1;
                            else if(a.data.ticker[currency].bid_price < b.data.ticker[currency].bid_price) return -1;
                            else return 0;
                        })

                        sockets.forEach((socket) =>
                        {
                            if(amount > 0)
                            {
                                wallet_summary[currency] += Math.min(amount, socket.data.ticker[currency].bid_amount) * socket.data.ticker[currency].bid_price * forex_rate;
                                amount -= Math.min(amount,  socket.data.ticker[currency].bid_amount);
                            }
                        });
                        wallet_summary["sum"] += wallet_summary[currency];
                        wallet_summary[currency] += amount > 0 ? " + " + amount + "[" + currency + "]" : "";
                    }
                    else if (Object.keys(forex).includes(currency))
                    {
                        forex_rate = forex[forex_select.value] / forex[currency];
                        wallet_summary[currency] += amount * forex_rate;
                        wallet_summary["sum"] += wallet_summary[currency];
                    }
                    else
                    {
                        wallet_summary[currency] = amount + "[not found]"
                    }
                }
            }
            else
            {
                for (var currency in wallet)
                {
                    amount = wallet[currency];
                    wallet_summary[currency] = 0;
                    if (currencies.includes(currency))
                    {
                        wallet_summary[currency] += amount * trades[currency] * forex_rate;
                        wallet_summary["sum"] += wallet_summary[currency];
                    }
                    else if (Object.keys(forex).includes(currency))
                    {
                        forex_rate = forex[forex_select.value] / forex[currency];
                        wallet_summary[currency] += amount * forex_rate;
                        wallet_summary["sum"] += wallet_summary[currency];
                    }
                    else
                    {
                        wallet_summary[currency] = amount + "[not found]"
                    }
                }
            }

            for (var currency in wallet_summary)
            {
                summary_element = document.createElement("LI");
                summary_element.innerHTML = currency + ": " + wallet_summary[currency];

                // buy_button = document.createElement("A");
                // buy_button.href = "#";
                // buy_button.innerHTML = "+";
                // buy_button.addEventListener("click", function()
                // {
                //     wallet[currency]++;
                //     refresh_wallet(wallet);
                // });
                //
                // sell_button = document.createElement("A");
                // sell_button.href = "#";
                // sell_button.innerHTML = "-";
                // sell_button.addEventListener("click", function()
                // {
                //     wallet[currency]--;
                //     refresh_wallet(wallet);
                // });
                //
                // summary_element.appendChild(buy_button);
                // summary_element.appendChild(sell_button);
                wallet_summary_node.appendChild(summary_element);
            }
        }

        async function fetch_forex()
        {
           try
           {
               const response = await fetch('https://api.exchangeratesapi.io/latest?base=USD');
               const data = await response.json();
               return data.rates;
           }
           catch (error) { console.error(error); }
        }

        async function refresh()
        {
            forex = await fetch_forex();
            orders_data_list.innerHTML = "<li><span>CUR</span><span>BID</span><span>ASK</span></li>"
            trades_data_list.innerHTML = "<li><span>CUR</span><span>PRICE</span></li>"

            currencies.forEach((currency) =>
            {
                bids[currency] = [sockets[0].data.ticker[currency].bid_price, 0];
                asks[currency] = [sockets[0].data.ticker[currency].ask_price, 0];
                trades[currency] = sockets[0].data.trades[currency].price;

                sockets.forEach((socket) =>
                {
                    if(socket.data.ticker[currency].bid_price > bids[currency][0])
                    {
                        bids[currency] = [socket.data.ticker[currency].bid_price, socket.data.ticker[currency].bid_amount];
                    }
                    if(socket.data.ticker[currency].ask_price < asks[currency][0])
                    {
                        asks[currency] = [socket.data.ticker[currency].ask_price, socket.data.ticker[currency].ask_amount];
                    }
                    if(socket.data.trades[currency].price < trades[currency])
                    {
                        trades[currency] = socket.data.trades[currency].price;
                    }
                });

                forex_rate = forex[forex_select.value];

                order_li = document.createElement('LI');
                order_li.innerHTML = "<span>" + currency + "</span><span>" + (forex_rate * bids[currency][0]).toFixed(4) + "</span><span>" + (forex_rate * asks[currency][0]).toFixed(4) + "</span>";

                trade_li = document.createElement('LI');
                trade_li.innerHTML = "<span>" + currency + "</span><span>" + (forex_rate * trades[currency]).toFixed(4) + "</span><span>";

                orders_data_list.appendChild(order_li);
                trades_data_list.appendChild(trade_li);
            });

            refresh_wallet(wallet);
        }

        setTimeout(function () {
            refresh();
        }, 500);

        rates_container.appendChild(orders_data_list);
        setInterval(refresh, REFRESH_INTERVAL);

    </script>

    <footer>
        data:
        <a href="https://bitfinex.com/">bitfinex</a> |
        <a href="https://bitbay.net/">bitbay</a>
        <!--
         |
        <a href="https://ftx.com/">ftx</a> |
        <a href="https://www.bybit.com/">bybit</a> |
        <a href="https://whitebit.com/">whitebit</a>

         -->
        &copy <a href="https://github.com/japko-7">japko-7</a> 2020
    </footer>
</body>
</html>
